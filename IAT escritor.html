<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Escritor Galáctico</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: black;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: Arial, sans-serif;
      color: white;
    }
    canvas {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 0;
    }
    .editor {
      position: relative;
      z-index: 1;
      width: 60%;
      height: 70%;
      background: rgba(0,0,0,0.7);
      border: 2px solid white;
      border-radius: 10px;
      padding: 20px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input.titulo {
      background: transparent;
      border: none;
      border-bottom: 2px solid gray;
      color: white;
      font-size: 18px;
      margin-bottom: 10px;
      outline: none;
    }
    textarea {
      flex: 1;
      background: transparent;
      border: none;
      color: white;
      resize: none;
      font-size: 16px;
      outline: none;
    }
    .mode-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .mode-buttons button {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
    }
    .save {
      margin-top: 10px;
      padding: 10px;
      background: white;
      color: black;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .save:hover { background: #ddd; }
    .controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
      gap: 10px;
    }
    .clock {
      font-size: 96px;
      font-weight: bold;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      z-index: 2;
      color: white;
      transition: text-shadow 0.3s ease;
    }
    .clock.red {
      color: red;
      text-shadow: 0 0 25px rgba(255,0,0,0.9), 0 0 50px rgba(255,0,0,0.6);
    }
    .circle-check {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      appearance: none;
      background: #555;
      cursor: pointer;
      position: relative;
    }
    .circle-check:checked {
      background: #0f0;
    }
  </style>
</head>
<body>
  <canvas id="stars"></canvas>

  <div class="editor" id="editor">
    <div class="mode-buttons">
      <button style="background:red" onclick="setMode('galaxy')"></button>
      <button style="background:blue" onclick="setMode('rain')"></button>
      <button style="background:yellow" onclick="setMode('fireflies')"></button>
    </div>
    <input id="titulo" class="titulo" placeholder="Título del libro" />
    <textarea id="texto" placeholder="Empieza a escribir aquí..."></textarea>
    <button class="save" onclick="guardarTexto()">Guardar</button>
    <div class="controls">
      <input type="range" id="speed" min="1" max="10" value="5">
      <input type="checkbox" id="toggleClock">
      <input type="checkbox" id="invertColors" class="circle-check">
    </div>
  </div>

  <div id="clock" class="clock"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const canvas = document.getElementById('stars');
      const ctx = canvas.getContext('2d');
      const editor = document.getElementById('editor');
      const textarea = document.getElementById('texto');
      const titulo = document.getElementById('titulo');
      const speedControl = document.getElementById('speed');
      const toggleClock = document.getElementById('toggleClock');
      const invertColors = document.getElementById('invertColors');
      const clock = document.getElementById('clock');

      let w = canvas.width = window.innerWidth;
      let h = canvas.height = window.innerHeight;
      let particles = [];
      let mode = 'galaxy';
      let keyupTimeout;
      let speedFactor = 1;
      let flashRed = false;
      let inverted = false;

      function createParticles(count) {
        particles = [];
        for (let i = 0; i < count; i++) {
          if (mode === 'fireflies') {
            particles.push({
              x: Math.random() * w,
              y: Math.random() * h,
              r: Math.random() * 2,
              dx: (Math.random() - 0.5) * 1,
              dy: (Math.random() - 0.5) * 1,
              alpha: Math.random()
            });
          } else if (mode === 'rain') {
            particles.push({
              x: Math.random() * w,
              y: Math.random() * h,
              speed: 2 + Math.random() * 4
            });
          } else {
            particles.push({
              x: Math.random() * w - w/2,
              y: Math.random() * h - h/2,
              z: Math.random() * w
            });
          }
        }
      }

      function animate() {
        ctx.fillStyle = inverted ? 'white' : 'black';
        ctx.fillRect(0, 0, w, h);

        let particleColor = flashRed ? 'red' : (inverted ? 'black' : 'white');

        if (mode === 'galaxy') {
          ctx.fillStyle = particleColor;
          particles.forEach(s => {
            s.z -= 2 * speedFactor;
            if (s.z <= 0) s.z = w;
            let k = 128.0 / s.z;
            let px = s.x * k + w / 2;
            let py = s.y * k + h / 2;
            if (px >= 0 && px <= w && py >= 0 && py <= h) {
              let size = (1 - s.z / w) * 3;
              ctx.beginPath();
              ctx.arc(px, py, size, 0, Math.PI * 2);
              ctx.fill();
            }
          });
        } else if (mode === 'rain') {
          ctx.fillStyle = particleColor;
          particles.forEach(r => {
            ctx.fillRect(r.x, r.y, 2, 10);
            r.y += r.speed * speedFactor;
            if (r.y > h) {
              r.y = -10;
              r.x = Math.random() * w;
            }
          });
        } else if (mode === 'fireflies') {
          particles.forEach(f => {
            ctx.beginPath();
            ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
            let baseColor;
            if (flashRed) {
              baseColor = 'rgba(255,0,0,0.9)';
            } else if (inverted) {
              baseColor = 'black';
            } else {
              baseColor = `rgba(255,255,180,${0.5 + 0.5*Math.sin(Date.now()/500 + f.alpha*10)})`;
            }
            ctx.fillStyle = baseColor;
            ctx.fill();
            f.x += f.dx * speedFactor;
            f.y += f.dy * speedFactor;
            if (f.x < 0 || f.x > w) f.dx *= -1;
            if (f.y < 0 || f.y > h) f.dy *= -1;
          });
        }

        requestAnimationFrame(animate);
      }

      function setMode(m) {
        mode = m;
        createParticles(300);
      }
      window.setMode = setMode;

      function guardarTexto() {
        const contenido = textarea.value;
        const nombre = titulo.value.trim() || 'libro';

        localStorage.setItem('titulo', nombre);
        localStorage.setItem('libro', contenido);

        const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8' });
        const enlace = document.createElement('a');
        enlace.href = URL.createObjectURL(blob);
        enlace.download = nombre + '.txt';
        enlace.click();
      }
      window.guardarTexto = guardarTexto;

      textarea.addEventListener('keydown', () => {
        let color = 'rgba(255,255,150,0.8)';
        if (mode === 'galaxy') color = 'rgba(255,0,0,0.8)';
        else if (mode === 'rain') color = 'rgba(0,150,255,0.8)';
        else if (mode === 'fireflies') color = 'rgba(255,255,150,0.8)';
        editor.style.boxShadow = `0 0 20px 5px ${color}`;
        if (keyupTimeout) clearTimeout(keyupTimeout);
      });

      textarea.addEventListener('keyup', () => {
        if (keyupTimeout) clearTimeout(keyupTimeout);
        keyupTimeout = setTimeout(() => {
          editor.style.boxShadow = "none";
        }, 300);
      });

      speedControl.addEventListener('input', () => {
        speedFactor = speedControl.value / 5; // rango 0.2 - 2
      });

      toggleClock.addEventListener('change', () => {
        clock.style.display = toggleClock.checked ? 'block' : 'none';
      });

      invertColors.addEventListener('change', () => {
        inverted = invertColors.checked;
      });

      setInterval(() => {
        if (toggleClock.checked) {
          const now = new Date();
          let hours = now.getHours();
          const ampm = hours >= 12 ? 'PM' : 'AM';
          hours = hours % 12;
          hours = hours ? hours : 12;
          const h = String(hours).padStart(2,'0');
          const m = String(now.getMinutes()).padStart(2,'0');
          const s = String(now.getSeconds()).padStart(2,'0');
          clock.textContent = `${h}:${m}:${s} ${ampm}`;
          flashRed = !flashRed;
          clock.classList.toggle('red');
        }
      },1000);

      window.addEventListener('resize', () => {
        w = canvas.width = window.innerWidth;
        h = canvas.height = window.innerHeight;
        createParticles(300);
      });

      createParticles(300);
      animate();

      const guardado = localStorage.getItem('libro');
      const tituloGuardado = localStorage.getItem('titulo');
      if (guardado) textarea.value = guardado;
      if (tituloGuardado) titulo.value = tituloGuardado;
    });
  </script>
</body>
</html>
